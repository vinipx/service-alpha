name: Agentic SDLC (Manual Trigger)

on:
  workflow_dispatch:
    inputs:
      jira_key:
        description: "Jira key (e.g., PROJ-123)"
        required: true
        type: string
      jira_url:
        description: "Jira issue URL"
        required: true
        type: string
      story_summary:
        description: "Short summary of the story"
        required: true
        type: string
      impacted_repositories:
        description: "Comma-separated list (service-alpha,service-beta,common-library)"
        required: true
        type: string
      risk_level:
        description: "Risk level"
        required: true
        default: "medium"
        type: choice
        options:
          - low
          - medium
          - high

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      branch_name: ${{ steps.vars.outputs.branch_name }}
      plan_file: ${{ steps.vars.outputs.plan_file }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up variables
        id: vars
        run: |
          SAFE_JIRA=$(echo "${{ github.event.inputs.jira_key }}" | tr '[:upper:]' '[:lower:]' | tr -cd 'a-z0-9-')
          BRANCH="agentic/${SAFE_JIRA}"
          PLAN_FILE="docs/implementation-plans/${SAFE_JIRA}-plan.md"
          echo "branch_name=${BRANCH}" >> "$GITHUB_OUTPUT"
          echo "plan_file=${PLAN_FILE}" >> "$GITHUB_OUTPUT"

      - name: Create implementation plan artifact
        run: |
          mkdir -p docs/implementation-plans
          cat > "${{ steps.vars.outputs.plan_file }}" << 'EOF'
          # Implementation Plan

          - Jira Key: ${{ github.event.inputs.jira_key }}
          - Jira URL: ${{ github.event.inputs.jira_url }}
          - Story Summary: ${{ github.event.inputs.story_summary }}
          - Impacted Repositories: ${{ github.event.inputs.impacted_repositories }}
          - Risk Level: ${{ github.event.inputs.risk_level }}

          ## Planned Steps
          1. Ingest requirement from Jira
          2. Perform cross-repo impact analysis
          3. Implement required code changes
          4. Add/update unit and integration tests
          5. Open PR and request CODEOWNERS review

          ## Notes
          - This is an automation scaffold.
          - Replace/extend with real Jira API + coding agent integrations as needed.
          EOF

      - name: Commit plan to feature branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -b "${{ steps.vars.outputs.branch_name }}"
          git add "${{ steps.vars.outputs.plan_file }}"
          git commit -m "chore(plan): add implementation plan for ${{ github.event.inputs.jira_key }}"
          git push --set-upstream origin "${{ steps.vars.outputs.branch_name }}"

  pr:
    runs-on: ubuntu-latest
    needs: plan
    steps:
      - name: Create Pull Request
        uses: actions/github-script@v7
        with:
          script: |
            const branch = "${{ needs.plan.outputs.branch_name }}";
            const jiraKey = "${{ github.event.inputs.jira_key }}";
            const jiraUrl = "${{ github.event.inputs.jira_url }}";

            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[${jiraKey}] Agentic SDLC plan scaffold`,
              head: branch,
              base: "main",
              body: [
                `Jira: ${jiraUrl}`,
                ``,
                `This PR was generated by the Agentic SDLC workflow scaffold.`,
                `It adds a structured implementation plan artifact and prepares the repository for agent-driven execution.`,
                ``,
                `@vinipxf please review (CODEOWNERS should also auto-request review).`
              ].join("\n")
            });

            core.info(`PR created: ${pr.html_url}`);
